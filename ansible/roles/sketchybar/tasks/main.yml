---
# ==============================================================================
# SketchyBar Configuration Role
# ==============================================================================
# Configures SketchyBar custom menu bar
# Installation handled by homebrew role via Brewfile
# ==============================================================================

- name: Enable separate Spaces per display
  shell: defaults write com.apple.spaces spans-displays -bool false
  tags: sketchybar

- name: Create SketchyBar config directory
  file:
    path: "{{ sketchybar_config_path | dirname }}"
    state: directory
    mode: '0755'
  tags: sketchybar

- name: Create SketchyBar plugins directory
  file:
    path: "{{ sketchybar_plugins_path }}"
    state: directory
    mode: '0755'
  tags: sketchybar

- name: Deploy SketchyBar configuration
  copy:
    src: sketchybarrc
    dest: "{{ sketchybar_config_path }}"
    mode: '0755'
  tags: sketchybar

- name: Deploy SketchyBar plugins
  copy:
    src: plugins/
    dest: "{{ sketchybar_plugins_path }}/"
    mode: '0755'
  tags: sketchybar

- name: Check if SketchyBar is running
  shell: brew services list | grep sketchybar | grep started || true
  register: sketchybar_status
  changed_when: false
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_facts['env']['PATH'] }}"
  tags: sketchybar

- name: Start SketchyBar service
  command: brew services start sketchybar
  when: sketchybar_status.stdout == ""
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_facts['env']['PATH'] }}"
  tags: sketchybar

- name: Restart SketchyBar service if already running
  command: brew services restart sketchybar
  when: sketchybar_status.stdout != ""
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_facts['env']['PATH'] }}"
  tags: sketchybar

- name: Auto-hide macOS menu bar
  shell: defaults write NSGlobalDomain _HIHideMenuBar -bool true
  tags: sketchybar

- name: Restart SystemUIServer to apply menu bar changes
  command: killall SystemUIServer
  ignore_errors: yes
  tags: sketchybar

---
# ------------------
# Finder Defaults
# ------------------
- name: Show hidden files
  shell: defaults write com.apple.finder AppleShowAllFiles -bool true

- name: Show all file extensions
  shell: defaults write NSGlobalDomain AppleShowAllExtensions -bool true

- name: Prevent creation of .DS_Store on network drives
  shell: defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true

- name: Prevent .DS_Store files on USB drives
  shell: defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

- name: Clean up existing .DS_Store files from system
  shell: |
    find {{ ansible_facts['env']['HOME'] }} -name ".DS_Store" -type f -delete 2>/dev/null || true
    find /Volumes -name ".DS_Store" -type f -delete 2>/dev/null || true
  register: dsstore_cleanup
  changed_when: false
  failed_when: false

- name: Show full POSIX path in Finder window titles
  shell: defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

- name: Set Finder default location to Home folder
  shell: |
    defaults write com.apple.finder NewWindowTarget -string "PfHm"
    defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/"

- name: Enable spring-loading for folders
  shell: defaults write NSGlobalDomain com.apple.springing.enabled -bool true

- name: Reduce delay for spring-loaded folders
  shell: defaults write NSGlobalDomain com.apple.springing.delay -float 0.1

- name: Show status bar in Finder
  shell: defaults write com.apple.finder ShowStatusBar -bool true

- name: Show path bar in Finder
  shell: defaults write com.apple.finder ShowPathbar -bool true

- name: Set default Finder view to list view
  shell: defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

- name: Disable warning when changing file extensions
  shell: defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

- name: Show Library folder
  shell: chflags nohidden ~/Library

- name: Keep folders on top when sorting
  shell: defaults write com.apple.finder _FXSortFoldersFirst -bool true

- name: Search current folder by default
  shell: defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

- name: Expand save panel by default
  shell: defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true

# ------------------
# Dock Tweaks
# ------------------
- name: Automatically hide the Dock
  shell: defaults write com.apple.dock autohide -bool true

- name: Remove Dock auto-hide delay
  shell: defaults write com.apple.dock autohide-delay -float 0

- name: Make Dock appear instantly
  shell: defaults write com.apple.dock autohide-time-modifier -float 0

- name: Minimize windows into application icon
  shell: defaults write com.apple.dock minimize-to-application -bool true

- name: Disable recent apps in Dock
  shell: defaults write com.apple.dock show-recents -bool false

- name: Reset Dock to empty
  shell: |
    defaults write com.apple.dock persistent-apps -array
    defaults write com.apple.dock persistent-others -array

- name: Set Dock icon size
  shell: defaults write com.apple.dock tilesize -int 56

- name: Set Dock minimize animation to scale
  shell: defaults write com.apple.dock mineffect -string "scale"

# ------------------
# Keyboard & Input
# ------------------
- name: Set key repeat rate (fast)
  shell: defaults write NSGlobalDomain KeyRepeat -int 2

- name: Set initial key repeat delay (short)
  shell: defaults write NSGlobalDomain InitialKeyRepeat -int 15

- name: Disable text completion
  shell: defaults write NSGlobalDomain NSAutomaticTextCompletionEnabled -bool false

- name: Enable full keyboard access for all controls
  shell: defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

- name: Disable press-and-hold for special characters (enable key repeat)
  shell: defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# ------------------
# System-wide Auto-Correct & Text Substitutions
# ------------------
- name: Disable auto spelling correction
  shell: defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

- name: Disable automatic capitalization
  shell: defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false

- name: Disable smart dashes
  shell: defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

- name: Disable smart quotes
  shell: defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# Disable to avoid interference with Espanso and Alfred
- name: Disable period substitution (double-space -> period)
  shell: defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false

# ------------------
# System Preferences
# ------------------
- name: Disable UI animations
  shell: defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false

- name: Disable sound effects
  shell: defaults write com.apple.systemsound "com.apple.sound.uiaudio.enabled" -int 0

- name: Create Screenshots directory
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/Screenshots"
    state: directory
    mode: '0755'

# When using macOS screenshot app
- name: Set screenshots location
  shell: defaults write com.apple.screencapture location -string "{{ ansible_facts['env']['HOME'] }}/Screenshots"

- name: Set screenshots format to PNG
  shell: defaults write com.apple.screencapture type -string "png"

- name: Disable screenshot thumbnail preview
  shell: defaults write com.apple.screencapture show-thumbnail -bool false

# Three fingers touch = 2 fingers pressing the trackpad
- name: Enable three-finger drag (Accessibility)
  shell: defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -bool true

- name: Set scroll direction to natural
  shell: defaults write NSGlobalDomain com.apple.swipescrolldirection -bool true

# ------------------
# Security
# ------------------
- name: Require password immediately after sleep
  shell: defaults write com.apple.screensaver askForPasswordDelay -int 0

- name: Enable firewall
  shell: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
  become: yes

- name: Enable stealth mode
  shell: /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on
  become: yes

# ------------------
# Night Shift
# ------------------
- name: Configure Night Shift schedule (19:00 - 04:00)
  shell: nightlight schedule 19:00 4:00
  args:
    executable: /bin/bash
  failed_when: false
  changed_when: false

# ------------------
# Menu Bar
# ------------------

# Stopped working on macOS Sequoia
# - name: Show battery percentage
  # shell: defaults write com.apple.menuextra.battery ShowPercent -bool true

- name: Use 24-hour time format
  shell: defaults write NSGlobalDomain AppleICUForce24HourTime -bool true


# ------------------
# Other System Settings
# ------------------
- name: Expand print dialog by default
  shell: defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true

- name: Disable resume system-wide
  shell: defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool false

- name: Disable disk image verification
  shell: defaults write com.apple.frameworks.diskimages skip-verify -bool true

- name: Disable Time Machine prompts for new disks
  shell: defaults write com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true


# ------------------
# Login Items & App Settings
# ------------------
- name: Remove Firefox from login items (prevent autostart)
  shell: osascript -e 'tell application "System Events" to delete login item "Firefox"' 2>/dev/null || true
  changed_when: false
  failed_when: false

- name: Hide AlDente from dock (LSUIElement)
  shell: |
    ALDENTE_PATH="/Applications/AlDente.app"
    if [ -d "$ALDENTE_PATH" ]; then
      # Add LSUIElement to Info.plist to hide from dock
      /usr/libexec/PlistBuddy -c "Delete :LSUIElement" "$ALDENTE_PATH/Contents/Info.plist" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :LSUIElement bool true" "$ALDENTE_PATH/Contents/Info.plist"
      # Clear launch services cache and restart app
      /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$ALDENTE_PATH"
      killall AlDente 2>/dev/null || true
      sleep 1
      open -a AlDente
    fi
  changed_when: false
  failed_when: false

# ------------------
# Apply changes
# ------------------
- name: Restart Finder to apply changes
  shell: killall Finder || true

- name: Restart Dock to apply changes
  shell: killall Dock || true

- name: Restart UI (menu bar) to apply changes
  shell: killall SystemUIServer || true

---
# ==============================================================================
# Homebrew Installation and Package Management Role
# ==============================================================================
# This role ensures Homebrew is installed and manages packages via Brewfile
# Assumes macOS on Apple Silicon (/opt/homebrew)
# ==============================================================================

- name: Check if Homebrew is installed
  stat:
    path: /opt/homebrew/bin/brew
  register: brew_installed

- name: Install Homebrew
  when: not brew_installed.stat.exists
  shell: |
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    executable: /bin/bash
  environment:
    NONINTERACTIVE: "1"

- name: Add Homebrew to PATH
  lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bash_profile"
    line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
    create: yes
    mode: '0644'

- name: Update Homebrew
  homebrew:
    update_homebrew: yes
  tags:
    - homebrew

- name: Install packages from Brewfile
  shell: |
    eval "$(/opt/homebrew/bin/brew shellenv)"
    brew bundle --file="{{ playbook_dir }}/Brewfile"
  args:
    executable: /bin/bash
  tags:
    - homebrew

- name: Cleanup old Homebrew versions
  shell: brew cleanup
  args:
    executable: /bin/bash
  tags:
    - homebrew
    - cleanup


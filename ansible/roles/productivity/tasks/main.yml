---
# ==============================================================================
# Productivity Apps Configuration Role
# ==============================================================================
# Configures productivity applications and menu bar apps
# ==============================================================================

- name: Configure menu bar apps to run as background apps (hide from dock)
  block:
    - name: Check if app is installed
      stat:
        path: "/Applications/{{ item }}.app"
      register: app_check
      loop:
        - AlDente
        - Maccy
        - Stats
        - Ice

    - name: Set apps as background apps (LSUIElement)
      shell: |
        /usr/libexec/PlistBuddy -c "Add :LSUIElement bool true" "/Applications/{{ item.item }}.app/Contents/Info.plist" 2>/dev/null || \
        /usr/libexec/PlistBuddy -c "Set :LSUIElement true" "/Applications/{{ item.item }}.app/Contents/Info.plist"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
      ignore_errors: yes

    - name: Touch apps to update Launch Services database
      shell: touch "/Applications/{{ item.item }}.app"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
  tags: productivity

- name: Configure startup applications
  block:
    - name: Add apps to login items
      shell: |
        osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/{{ item }}.app", hidden:false}'
      loop:
        - Alfred 5
        - Maccy
        - AlDente
        - Ice
        - Little Snitch
        - Stats
        - SketchyBar
      ignore_errors: yes
  tags: productivity


##########################

- name: Configure Alfred to replace Spotlight
  block:
    - name: Get current user for preference paths
      set_fact:
        current_user: "{{ ansible_facts['env']['USER'] }}"
        home_dir: "{{ ansible_facts['env']['HOME'] }}"

    - name: Create backup of symbolic hotkeys preferences
      shell: |
        cp "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist" \
           "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist.backup" || true
      ignore_errors: yes

    - name: Disable Spotlight search shortcut (Cmd+Space) using PlistBuddy
      shell: |
        /usr/libexec/PlistBuddy -c "Delete :AppleSymbolicHotKeys:64" "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:enabled bool false" "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist"
      ignore_errors: yes

    - name: Disable Finder search window shortcut (Opt+Cmd+Space) using PlistBuddy
      shell: |
        /usr/libexec/PlistBuddy -c "Delete :AppleSymbolicHotKeys:65" "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:65:enabled bool false" "{{ home_dir }}/Library/Preferences/com.apple.symbolichotkeys.plist"
      ignore_errors: yes

    - name: Kill cfprefsd to clear preferences cache (CRITICAL)
      shell: |
        killall cfprefsd || true
      ignore_errors: yes
      tags: productivity

    - name: Restart SystemUIServer to apply changes
      shell: |
        killall SystemUIServer || true
      ignore_errors: yes

    - name: Wait for services to restart
      pause:
        seconds: 2

    - name: Check if Alfred has been launched (prefs.json exists)
      stat:
        path: "{{ home_dir }}/Library/Application Support/Alfred/prefs.json"
      register: alfred_prefs_json

    - name: Warn if Alfred prefs.json not found
      debug:
        msg: "WARNING: Alfred prefs.json not found. Please launch Alfred at least once before running this playbook."
      when: not alfred_prefs_json.stat.exists

    - name: Get Alfred local hash from prefs.json
      shell: |
        python3 -c "import json; print(json.load(open('{{ home_dir }}/Library/Application Support/Alfred/prefs.json'))['localhash'])"
      register: alfred_localhash
      when: alfred_prefs_json.stat.exists
      ignore_errors: yes

    - name: Get Alfred preferences bundle path
      shell: |
        python3 -c "import json; print(json.load(open('{{ home_dir }}/Library/Application Support/Alfred/prefs.json'))['current'])"
      register: alfred_prefs_path
      when: alfred_prefs_json.stat.exists
      ignore_errors: yes

    - name: Create Alfred hotkey preferences directory
      file:
        path: "{{ alfred_prefs_path.stdout }}/preferences/local/{{ alfred_localhash.stdout }}/hotkey"
        state: directory
        mode: '0755'
      when: alfred_prefs_json.stat.exists and alfred_localhash.stdout | default('') != "" and alfred_prefs_path.stdout | default('') != ""
      ignore_errors: yes

    - name: Write Alfred hotkey preferences (Cmd+Space)
      copy:
        dest: "{{ alfred_prefs_path.stdout }}/preferences/local/{{ alfred_localhash.stdout }}/hotkey/prefs.plist"
        content: |
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>default</key>
          	<dict>
          		<key>key</key>
          		<integer>49</integer>
          		<key>mod</key>
          		<integer>1048576</integer>
          		<key>string</key>
          		<string> </string>
          	</dict>
          </dict>
          </plist>
        mode: '0644'
      when: alfred_prefs_json.stat.exists and alfred_localhash.stdout | default('') != "" and alfred_prefs_path.stdout | default('') != ""
      ignore_errors: yes

    - name: Quit Alfred if running
      shell: |
        osascript -e 'quit app "Alfred 5"' 2>/dev/null || osascript -e 'quit app "Alfred"' 2>/dev/null || true
      ignore_errors: yes

    - name: Wait before restarting Alfred
      pause:
        seconds: 1

    - name: Start Alfred to load new settings
      shell: |
        open -a "Alfred 5" 2>/dev/null || open -a "Alfred" 2>/dev/null || true
      ignore_errors: yes

    - name: Display configuration status
      debug:
        msg: |
          Alfred/Spotlight configuration has been applied.

          Spotlight shortcuts have been disabled.
          Alfred hotkey has been set to Cmd+Space.

          Press Cmd+Space to verify Alfred opens.

          Note: If Alfred hotkey was not set, ensure Alfred has been launched
          at least once before running this playbook (to create prefs.json).
  tags: productivity

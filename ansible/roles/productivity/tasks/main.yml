---
# ==============================================================================
# Productivity Apps Configuration Role
# ==============================================================================
# Configures productivity applications and menu bar apps
# ==============================================================================

- name: Configure menu bar apps to run as background apps (hide from dock)
  block:
    - name: Check if app is installed
      stat:
        path: "/Applications/{{ item }}.app"
      register: app_check
      loop:
        - AlDente
        - Maccy
        - Stats
        - Ice

    - name: Set apps as background apps (LSUIElement)
      shell: |
        /usr/libexec/PlistBuddy -c "Add :LSUIElement bool true" "/Applications/{{ item.item }}.app/Contents/Info.plist" 2>/dev/null || \
        /usr/libexec/PlistBuddy -c "Set :LSUIElement true" "/Applications/{{ item.item }}.app/Contents/Info.plist"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
      ignore_errors: yes

    - name: Touch apps to update Launch Services database
      shell: touch "/Applications/{{ item.item }}.app"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
  tags: productivity

- name: Configure startup applications
  block:
    - name: Add apps to login items
      shell: |
        osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/{{ item }}.app", hidden:false}'
      loop:
        - Alfred 5
        - Maccy
        - AlDente
        - Ice
        - Little Snitch
        - Stats
        - SketchyBar
      ignore_errors: yes
  tags: productivity


##########################

- name: Configure Alfred to replace Spotlight
  block:
    - name: Install Homebrew (if not already installed)
      shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew
      tags: productivity

    - name: Install Alfred via Homebrew Cask
      homebrew_cask:
        name: alfred
        state: present
        install_options: "no-quarantine"
      tags: productivity

    - name: Disable Spotlight Cmd+Space shortcut
      shell: |
        /usr/bin/defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 64 \
        '{ enabled = 0; value = { parameters = (49, 49, 1048576); type = "standard"; }; }'
      ignore_errors: yes
      tags: productivity

    - name: Set Alfred hotkey to Cmd+Space
      shell: |
        /usr/bin/defaults write com.runningwithcrayons.Alfred-Preferences hotkey -dict-add default \
        '<dict><key>key</key><integer>49</integer><key>mod</key><integer>1048576</integer><key>string</key><string> </string></dict>'
      ignore_errors: yes
      tags: productivity

    - name: Ensure Alfred is not quarantined
      shell: |
        xattr -cr /Applications/Alfred.app || true
      tags: productivity

    - name: Restart macOS UI services to apply shortcuts
      shell: |
        killall SystemUIServer || true
        killall Dock || true
      tags: productivity

---
# ==============================================================================
# Productivity Apps Configuration Role
# ==============================================================================
# Configures productivity applications and menu bar apps
# ==============================================================================

- name: Configure menu bar apps to run as background apps (hide from dock)
  block:
    - name: Check if app is installed
      stat:
        path: "/Applications/{{ item }}.app"
      register: app_check
      loop:
        - AlDente
        - Maccy
        - Stats
        - Ice

    - name: Set apps as background apps (LSUIElement)
      shell: |
        /usr/libexec/PlistBuddy -c "Add :LSUIElement bool true" "/Applications/{{ item.item }}.app/Contents/Info.plist" 2>/dev/null || \
        /usr/libexec/PlistBuddy -c "Set :LSUIElement true" "/Applications/{{ item.item }}.app/Contents/Info.plist"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
      ignore_errors: yes

    - name: Touch apps to update Launch Services database
      shell: touch "/Applications/{{ item.item }}.app"
      loop: "{{ app_check.results }}"
      when: item.stat.exists
  tags: productivity

- name: Configure startup applications
  block:
    - name: Add apps to login items
      shell: |
        osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/{{ item }}.app", hidden:false}'
      loop:
        - Alfred 5
        - Maccy
        - AlDente
        - Ice
        - Little Snitch
        - Stats
        - SketchyBar
      ignore_errors: yes
  tags: productivity

- name: Configure Alfred to replace Spotlight
  block:
    - name: Disable Spotlight search shortcut (Cmd+Space)
      shell: |
        defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 64 '{enabled = 0; value = { parameters = (65535, 49, 1048576); type = standard; }; }'
      ignore_errors: yes

    - name: Disable Finder search window shortcut
      shell: |
        defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 65 '{enabled = 0; value = { parameters = (65535, 49, 1572864); type = standard; }; }'
      ignore_errors: yes

    - name: Restart SystemUIServer to apply shortcut changes
      shell: killall SystemUIServer || true
      ignore_errors: yes

    - name: Set Alfred hotkey to Cmd+Space
      shell: |
        defaults write com.runningwithcrayons.Alfred-Preferences hotkey -int 49
        defaults write com.runningwithcrayons.Alfred-Preferences hotkeyMod -int 1048576
      ignore_errors: yes

    - name: Start Alfred to apply settings
      shell: open -a "Alfred 5" || open -a "Alfred"
      ignore_errors: yes
  tags: productivity

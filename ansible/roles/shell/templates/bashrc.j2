# ==============================================================================
# Bash Configuration (.bashrc)
# ==============================================================================
# Portable bash configuration that works on both macOS and Linux
# Enhanced for local use with modern CLI tools, but degrades gracefully
# ==============================================================================

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
export EDITOR=vim
export VISUAL=vim
export PAGER=less

# XDG Base Directory specification
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"

# PATH configuration
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

# ------------------------------------------------------------------------------
# Shell Options
# ------------------------------------------------------------------------------
# History
export HISTCONTROL=ignoredups:erasedups
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S  "
shopt -s histappend         # Append to history, don't overwrite
shopt -s cmdhist            # Save multi-line commands as one command

# Shell behavior
shopt -s checkwinsize       # Update LINES and COLUMNS after each command
shopt -s cdspell            # Autocorrect typos in path names
shopt -s dirspell           # Autocorrect directory names during completion
shopt -s globstar           # Enable ** recursive glob
shopt -s nocaseglob         # Case-insensitive globbing

# ------------------------------------------------------------------------------
# Enhanced CLI Tools (with fallbacks)
# ------------------------------------------------------------------------------
# ls -> eza (if available)
if command -v eza &> /dev/null; then
    alias ls='eza --group-directories-first --icons'
    alias ll='eza -lah --git --group-directories-first --icons'
    alias la='eza -a --group-directories-first --icons'
    alias l='eza -lh --git --group-directories-first --icons'
    alias lt='eza -T --group-directories-first --icons'
    alias tree='eza -T --group-directories-first --icons'
else
    alias ls='ls -GFh'
    alias ll='ls -lah'
    alias la='ls -A'
    alias l='ls -CF'
fi

# cat -> bat (if available)
if command -v bat &> /dev/null; then
    alias cat='bat --style=auto'
    export BAT_THEME="Monokai Extended"
    export BAT_PAGER="less -RF"
fi

# find -> fd (if available)
if command -v fd &> /dev/null; then
    alias find='fd'
fi

# grep enhancements
if command -v rg &> /dev/null; then
    alias grep='rg'
else
    alias grep='grep --color=auto'
fi

# ------------------------------------------------------------------------------
# Directory Navigation
# ------------------------------------------------------------------------------
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'
alias ~='cd ~'
alias -- -='cd -'

# ------------------------------------------------------------------------------
# Common Aliases
# ------------------------------------------------------------------------------
alias h='history'
alias j='jobs -l'
alias c='clear'
alias reload='source ~/.bashrc && echo "Bashrc reloaded"'

# Safety nets
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'
alias ln='ln -i'

# Convenience
alias mkdir='mkdir -p'
alias which='command -v'
alias path='echo -e ${PATH//:/\\n}'

# ------------------------------------------------------------------------------
# Git Aliases (portable)
# ------------------------------------------------------------------------------
alias g='git'
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'
alias gd='git diff'
alias gco='git checkout'
alias gb='git branch'
alias glog='git log --oneline --graph --decorate'

# ------------------------------------------------------------------------------
# Bash Completion
# ------------------------------------------------------------------------------
# macOS Homebrew completion
if [ -f /opt/homebrew/etc/bash_completion ]; then
    . /opt/homebrew/etc/bash_completion
fi

# Linux system completion
if [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
fi

# ------------------------------------------------------------------------------
# FZF Integration (if available)
# ------------------------------------------------------------------------------
if command -v fzf &> /dev/null; then
    # Load fzf key bindings and completion
    [ -f ~/.fzf.bash ] && source ~/.fzf.bash

    # Use fd for fzf if available
    if command -v fd &> /dev/null; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
    fi

    # fzf color scheme
    export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'
fi

# ------------------------------------------------------------------------------
# Zoxide Integration (smart cd)
# ------------------------------------------------------------------------------
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init bash)"
    alias cd='z'
fi

# ------------------------------------------------------------------------------
# Starship Prompt (cross-shell)
# ------------------------------------------------------------------------------
if command -v starship &> /dev/null; then
    eval "$(starship init bash)"
else
    # Fallback to basic prompt if starship not available
    PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
fi

# ------------------------------------------------------------------------------
# Local Overrides
# ------------------------------------------------------------------------------
# Source local bashrc for machine-specific configurations
[ -f ~/.bashrc.local ] && source ~/.bashrc.local

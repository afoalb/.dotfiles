# ==============
# Zsh Configuration (.zshrc)
# ==============

# ------------------
# Source Common Shell Configuration
# ------------------
[ -f ~/.shell_common.sh ] && source ~/.shell_common.sh


# ------------------
# Zsh Options
# ------------------
# Word Characters - Define what's considered part of a word
# for word-based navigation
# Removing '/' makes Ctrl-W and Alt-Backspace stop at path separators
WORDCHARS='*?_-.[]~=&;!#$%^(){}<>'

# History
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt EXTENDED_HISTORY          # Write timestamps to history
setopt HIST_EXPIRE_DUPS_FIRST    # Expire duplicate entries first
setopt HIST_IGNORE_DUPS          # Don't record duplicate entries
setopt HIST_IGNORE_SPACE         # Don't record entries starting with space
setopt HIST_VERIFY               # Show command with history expansion before running
setopt SHARE_HISTORY             # Share history between sessions

# Directory navigation
setopt AUTO_CD                   # Type directory name to cd
setopt AUTO_PUSHD                # Make cd push old directory onto stack
setopt PUSHD_IGNORE_DUPS         # Don't push duplicates
setopt PUSHD_SILENT              # Don't print directory stack

# Completion
setopt ALWAYS_TO_END             # Move cursor to end after completion
setopt AUTO_LIST                 # List choices on ambiguous completion
setopt AUTO_MENU                 # Show completion menu on tab
setopt COMPLETE_IN_WORD          # Complete from both ends of word
setopt GLOB_COMPLETE             # Show menu for glob matches

# Other
setopt INTERACTIVE_COMMENTS      # Allow comments in interactive shell
setopt MULTIOS                   # Perform multiple redirections
setopt NO_BEEP                   # No beeping


# ------------------
# Zsh Completion System
# ------------------
autoload -Uz compinit
compinit

# Case-insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# Menu selection
zstyle ':completion:*' menu select

# Colors in completion
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# Verbose completion
zstyle ':completion:*' verbose yes

# Group matches
zstyle ':completion:*' group-name ''

# Descriptions
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- no matches found --%f'


# ------------------
# Key Bindings
# ------------------
# Use emacs key bindings (can change to bindkey -v for vim mode)
bindkey -e

# Better history search
bindkey '^R' history-incremental-search-backward
bindkey '^S' history-incremental-search-forward

# Edit command line in editor
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^X^E' edit-command-line


# ------------------
# Zsh-specific Listing Functions
# ------------------
# These use zsh glob qualifiers which are not available in bash

# ll: long list, human readable, directories first then files (including hidden)
{% raw %}
ll() {
    local target="${1:-.}"
    local dirs files

    # Get directories and files separately using glob qualifiers
    # (/) = directories, (.) = regular files, D = include dotfiles, N = null glob
    dirs=("${target}"/*(ND/))
    files=("${target}"/*(ND.))

    # Print directories first, then files
    [[ ${#dirs} -gt 0 ]] && ls -lhFd "${dirs[@]}"
    [[ ${#files} -gt 0 ]] && ls -lhFd "${files[@]}"
}

# lld: same as ll but only directories
lld() {
    local target="${1:-.}"
    local dirs

    dirs=("${target}"/*(ND/))
    [[ ${#dirs} -gt 0 ]] && ls -lhFd "${dirs[@]}"
}

# llf: same as ll but only files
llf() {
    local target="${1:-.}"
    local files

    files=("${target}"/*(ND.))
    [[ ${#files} -gt 0 ]] && ls -lhFd "${files[@]}"
}

# lldot: same as ll but only dotfiles (files/dirs starting with .)
lldot() {
    local target="${1:-.}"
    local dotdirs dotfiles

    # Get hidden directories and files (exclude . and ..)
    dotdirs=("${target}"/.*(ND/))
    dotfiles=("${target}"/.*(ND.))

    # Print directories first, then files
    [[ ${#dotdirs} -gt 0 ]] && ls -lhFd "${dotdirs[@]}"
    [[ ${#dotfiles} -gt 0 ]] && ls -lhFd "${dotfiles[@]}"
}
{% endraw %}


# ------------------
# Zsh-specific Aliases
# ------------------
alias which='whence -p'
alias path='echo -e ${PATH//:/\\n}'
alias reload='source ~/.zshrc && echo "Zshrc reloaded"'


# ------------------
# FZF Zsh Integration
# ------------------
if (( $+commands[fzf] )); then
    [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
fi


# ------------------
# Local Overrides
# ------------------
# Source local zshrc for machine-specific configurations
[ -f ~/.zshrc.local ] && source ~/.zshrc.local


# ------------------
# Starship Prompt (zsh-specific init)
# ------------------
if (( $+commands[starship] )); then
    eval "$(starship init zsh)"
fi


# ------------------
# Zoxide (must be at the very end)
# ------------------
# NOTE: Config must be at the very end
# Zoxide should be initialized after all other shell modifications
if (( $+commands[zoxide] )); then
    eval "$(zoxide init zsh)"
fi

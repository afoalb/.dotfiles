# ==============
# Zsh Configuration (.zshrc)
# ==============

# ------------------
# Environment Variables
# ------------------
export EDITOR=nvim
export VISUAL=nvim
export PAGER=less

# XDG Base Directory specification
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"

# PATH configuration
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

# ------------------
# Zsh Options
# ------------------
# Word Characters - Define what's considered part of a word
# for word-based navigation
# Removing '/' makes Ctrl-W and Alt-Backspace stop at path separators
WORDCHARS='*?_-.[]~=&;!#$%^(){}<>'

# History
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt EXTENDED_HISTORY          # Write timestamps to history
setopt HIST_EXPIRE_DUPS_FIRST    # Expire duplicate entries first
setopt HIST_IGNORE_DUPS          # Don't record duplicate entries
setopt HIST_IGNORE_SPACE         # Don't record entries starting with space
setopt HIST_VERIFY               # Show command with history expansion before running
setopt SHARE_HISTORY             # Share history between sessions

# Directory navigation
setopt AUTO_CD                   # Type directory name to cd
setopt AUTO_PUSHD                # Make cd push old directory onto stack
setopt PUSHD_IGNORE_DUPS         # Don't push duplicates
setopt PUSHD_SILENT              # Don't print directory stack

# Completion
setopt ALWAYS_TO_END             # Move cursor to end after completion
setopt AUTO_LIST                 # List choices on ambiguous completion
setopt AUTO_MENU                 # Show completion menu on tab
setopt COMPLETE_IN_WORD          # Complete from both ends of word
setopt GLOB_COMPLETE             # Show menu for glob matches

# Other
setopt INTERACTIVE_COMMENTS      # Allow comments in interactive shell
setopt MULTIOS                   # Perform multiple redirections
setopt NO_BEEP                   # No beeping

# ------------------
# Zsh Completion System
# ------------------
autoload -Uz compinit
compinit

# Case-insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# Menu selection
zstyle ':completion:*' menu select

# Colors in completion
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# Verbose completion
zstyle ':completion:*' verbose yes

# Group matches
zstyle ':completion:*' group-name ''

# Descriptions
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- no matches found --%f'

# ------------------
# Key Bindings
# ------------------
# Use emacs key bindings (can change to bindkey -v for vim mode)
bindkey -e

# Better history search
bindkey '^R' history-incremental-search-backward
bindkey '^S' history-incremental-search-forward

# Edit command line in editor
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^X^E' edit-command-line


# ------------------
# Common Aliases
# ------------------
# Vim
ANSIBLE_REMINDER="NOTE: Run the ansible playbook to play the changes."

alias vim='nvim'
alias vi='vim'
alias vimrc='nvim ~/.dotfiles/ansible/roles/neovim/files/init.lua; echo "\n$ANSIBLE_REMINDER"'
alias zshrc='nvim ~/.dotfiles/ansible/roles/shell/templates/; echo "\n$ANSIBLE_REMINDER"'

# Basic listing
alias ls='ls -GFh'       # colorize, classify, human-readable sizes
alias l='ls -CF'         # compact view, classify (/ @ *)
alias la='ls -A'         # show hidden except . and ..
alias l1='ls -1'         # one entry per line

# Long listings
# Note: sort dirs first ='sort -k1,1r' (reverse on first column)
alias ll='ls -laF | sort -k1,1r -k9,9V'  # directories first, long + classify + hidden, natural sort
alias lh='ls -lh | sort -k1,1r -k9,9V'   # long + human sizes, directories first, natural sort
alias lt='ls -lt | sort -k1,1r'          # sort by modification time, dirs first
alias ltr='ls -ltr | sort -k1,1r'        # sort by time, oldest first, dirs first

# Directories / Files only
alias ld='ls -d */ | sort -V'             # list only directories, natural sort
alias lf='ls -p | grep -v / | sort -V'    # list only files, natural sort

# Safety nets
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'
alias ln='ln -i'

# Git (basics)
alias g='git'
alias gs='git status'
alias gb='git branch'
alias gco='git checkout'
alias glog='git log --oneline --graph --decorate'
alias glogall='git log --oneline --graph --decorate --all'

# zoxide
alias zz='zoxide query --list'

# Others
alias which='whence -p'
alias mkdir='mkdir -p'
alias h='history'
alias path='echo -e ${PATH//:/\\n}'
alias grep='grep --color=auto'
alias reload='source ~/.zshrc && echo "Zshrc reloaded"'


# ------------------
# Enhanced CLI Tools
# ------------------
# Use enhanced replacements for classic Unix tools with an 's' prefix
# (e.g. eza -> sls, bat -> scat, ripgrep -> sgrep, fd -> sfind)

# eza
if (( $+commands[eza] )); then
    EZA_COMMON="--group-directories-first --icons=never --color=auto"

    # Basic listing
    alias sls="eza $EZA_COMMON"                          # like ls -GFh
    alias sl="eza --long --classify $EZA_COMMON"         # like l='ls -CF'
    alias sla="eza --all $EZA_COMMON"                    # like la='ls -A'
    alias sl1="eza --oneline $EZA_COMMON"               # like l1='ls -1'

    # Long listings
    alias sll="eza --all --long --classify $EZA_COMMON" # like ll='ls -alF'
    alias slh="eza --long --all $EZA_COMMON"            # like lh='ls -lh'
    alias slt="eza --long --sort=modified $EZA_COMMON"  # like lt='ls -lt'
    alias sltr="eza --long --sort=modified --reverse $EZA_COMMON"  # like ltr='ls -ltr'

    # Directories / Files only
    alias sld="eza --dirs-only $EZA_COMMON"             # like ld='ls -d */'
    alias slf="eza --only-files $EZA_COMMON"            # like lf='ls -p | grep -v /'

    # Tree view
    alias stree="eza --tree --level=2 --long $EZA_COMMON" # tree view, 2 levels by default
fi

# bat
if (( $+commands[bat] )); then
    alias scat='bat --style=auto'
    export BAT_THEME="Monokai Extended"
    export BAT_PAGER="less -RF"
fi

# ripgrep
if (( $+commands[rg] )); then
    alias sgrep='rg'
fi


# ------------------
# FZF Integration
# ------------------
if (( $+commands[fzf] )); then
    # Load fzf key bindings
    [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

    # Use fd for fzf if available
    if (( $+commands[fd] )); then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
    fi

    # fzf color scheme and options
    export FZF_DEFAULT_OPTS='
        --height 40%
        --layout=reverse
        --border
        --preview "bat --style=numbers --color=always --line-range :500 {}"
        --preview-window=right:50%:wrap
    '
fi


# ------------------
# Starship Prompt
# ------------------
if (( $+commands[starship] )); then
    eval "$(starship init zsh)"
fi

# ------------------
# Homebrew Integration
# ------------------
if [ -f /opt/homebrew/bin/brew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# ------------------
# Local Overrides
# ------------------
# Source local zshrc for machine-specific configurations
[ -f ~/.zshrc.local ] && source ~/.zshrc.local


# ------------------
# Directory Navigation (Stack Navigation) (zoxide-style)
# ------------------
unalias d 2>/dev/null

# dd -> display directory stack
dd() {
    dirs -v
}

# d [n] -> jump to a directory from stack
d() {
    # No argument → show stack
    if [ -z "$1" ]; then
        dirs -v
        return
    fi

    # Argument is a number?
    case "$1" in
        ''|*[!0-9]*)
            # Not a number → error
            printf "Usage:\n  d        # show directory stack\n  d <num>  # jump to directory number\n"
            return 1
            ;;
        *)
            # Valid number → cd to it
            cd +"$1"
            ;;
    esac
}


# ------------------
# Directory Navigation (Zoxide)
# ------------------
# NOTE: Config must be at the very end
# Zoxide should be initialized after all other shell modifications
if (( $+commands[zoxide] )); then
    eval "$(zoxide init zsh)"
fi

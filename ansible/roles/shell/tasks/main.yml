---
# ===============
# Shell Configuration Role
# ===============
#
# Configures bash, zsh, and starship prompt
# Sets zsh as default shell with bash as fallback for portability
# ===============

# ------------------
# Shell Setup
# ------------------
- name: Ensure Homebrew zsh is available in /etc/shells
  become: yes
  lineinfile:
    path: /etc/shells
    line: "/opt/homebrew/bin/zsh"
    create: no
  tags: shell

- name: Set zsh as the default login shell
  shell: "chsh -s /opt/homebrew/bin/zsh {{ ansible_facts['env']['USER'] }}"
  become: yes
  when: ansible_facts['env']['SHELL'] != '/opt/homebrew/bin/zsh'
  tags: shell

# ------------------
# Common Shell Configuration
# ------------------
- name: Deploy common shell configuration
  template:
    src: shell_common.sh.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.shell_common.sh"
    mode: "0644"
  tags: shell

# ------------------
# Bash Configuration (portable, remote-compatible)
# ------------------
- name: Deploy .bash_profile
  template:
    src: bash_profile.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.bash_profile"
    mode: "0644"
  tags: shell

- name: Deploy .bashrc
  template:
    src: bashrc.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    mode: "0644"
  tags: shell

# ------------------
# Zsh Configuration (local)
# ------------------
- name: Deploy .zshrc
  template:
    src: zshrc.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    mode: "0644"
  tags: shell

- name: Create .zshrc.local if it doesn't exist
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.zshrc.local"
    state: touch
    mode: "0644"
    modification_time: preserve
    access_time: preserve
  tags: shell

# ------------------
# Starship Prompt Configuration
# ------------------
- name: Create starship config directory
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: "0755"
  tags: shell

- name: Deploy starship configuration
  template:
    src: starship.toml.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml"
    mode: "0644"
  tags: shell

# ------------------
# FZF Setup
# ------------------
# Sets PATH + loads key bindings + completions
- name: Install fzf key bindings
  shell: /opt/homebrew/opt/fzf/install --key-bindings --completion --no-update-rc
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.fzf.zsh"
  tags: shell

# ------------------
# Vim Configuration (basic, portable)
# ------------------
- name: Deploy .vimrc
  template:
    src: vimrc.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.vimrc"
    mode: "0644"
  tags: shell

# ------------------
# Git Configuration
# ------------------
- name: Deploy .gitconfig
  template:
    src: gitconfig.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    mode: "0644"
  tags: shell

# ------------------
# Tmux Configuration
# ------------------
- name: Install tmux
  homebrew:
    name: tmux
    state: present
  tags: shell

- name: Deploy .tmux.conf
  template:
    src: tmux.conf.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
    mode: "0644"
  tags: shell


---
# ==============================================================================
# VS Code Configuration Role
# ==============================================================================
# Configures VS Code with extensions
# Installation handled by homebrew role via Brewfile
# ==============================================================================

# Quit VS Code and disable crash dialogs before installing extensions
- name: Prepare VS Code for extension installation
  shell: |
    # Quit VS Code gracefully
    osascript -e 'tell application "Visual Studio Code" to quit' 2>/dev/null || true
    pkill -f "Visual Studio Code" 2>/dev/null || true
    # Kill any lingering Electron processes from VS Code
    pkill -f "Code Helper" 2>/dev/null || true
    sleep 2
    # Disable crash reporter dialog for this session
    defaults write com.apple.CrashReporter DialogType none 2>/dev/null || true
  changed_when: false
  failed_when: false
  tags: vscode

# Install VS Code extensions using --force flag and --disable-gpu to reduce crashes
- name: Install VS Code extensions
  shell: |
    # Run extension install with crash handling
    code --disable-gpu --force --install-extension {{ item }} 2>&1 &
    PID=$!
    # Wait for completion with timeout
    timeout 60 tail --pid=$PID -f /dev/null 2>/dev/null || true
    # Small delay between extensions
    sleep 1
  loop:
    - ms-python.python
    - ms-python.vscode-pylance
    - ms-python.debugpy
    - dbaeumer.vscode-eslint
    - esbenp.prettier-vscode
    - bradlc.vscode-tailwindcss
    - HashiCorp.terraform
    - redhat.ansible
    - ms-azuretools.vscode-docker
    - eamodio.gitlens
    - vscodevim.vim
    - shardulm94.trailing-spaces
    - oderwat.indent-rainbow
    - usernamehw.errorlens
    - ms-vscode-remote.remote-ssh
  changed_when: false
  failed_when: false
  tags: vscode

- name: Create VS Code user settings directory
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User"
    state: directory
    mode: '0755'
  tags: vscode

- name: Deploy VS Code settings
  copy:
    src: settings.json
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User/settings.json"
    mode: '0644'
  ignore_errors: yes
  tags: vscode

- name: Deploy VS Code keybindings
  copy:
    src: keybindings.json
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User/keybindings.json"
    mode: '0644'
  ignore_errors: yes
  tags: vscode

---
# ==============================================================================
# VS Code Configuration Role
# ==============================================================================
# Configures VS Code with extensions
# Installation handled by homebrew role via Brewfile
# ==============================================================================

# Quit VS Code before installing extensions to prevent Electron crash dialog
- name: Quit VS Code before extension installation
  shell: |
    osascript -e 'tell application "Visual Studio Code" to quit' 2>/dev/null || true
    pkill -f "Visual Studio Code" 2>/dev/null || true
    sleep 2
  changed_when: false
  failed_when: false
  tags: vscode

# Install VS Code extensions using --force flag
- name: Install VS Code extensions
  shell: |
    code --force --install-extension {{ item }} 2>&1 || true
  loop:
    - ms-python.python
    - ms-python.vscode-pylance
    - ms-python.debugpy
    - dbaeumer.vscode-eslint
    - esbenp.prettier-vscode
    - bradlc.vscode-tailwindcss
    - HashiCorp.terraform
    - redhat.ansible
    - ms-azuretools.vscode-docker
    - eamodio.gitlens
    - vscodevim.vim
    - shardulm94.trailing-spaces
    - oderwat.indent-rainbow
    - usernamehw.errorlens
    - ms-vscode-remote.remote-ssh
  changed_when: false
  failed_when: false
  tags: vscode

- name: Create VS Code user settings directory
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User"
    state: directory
    mode: '0755'
  tags: vscode

- name: Deploy VS Code settings
  copy:
    src: settings.json
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User/settings.json"
    mode: '0644'
  ignore_errors: yes
  tags: vscode

- name: Deploy VS Code keybindings
  copy:
    src: keybindings.json
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User/keybindings.json"
    mode: '0644'
  ignore_errors: yes
  tags: vscode

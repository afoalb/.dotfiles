---
# ==============================================================================
# Hammerspoon Configuration Role
# ==============================================================================
# Configures Hammerspoon automation engine for hotkeys and app launching
# Replaces skhd for better integration and more features
# ==============================================================================

- name: Create Hammerspoon config directory
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.hammerspoon"
    state: directory
    mode: '0755'
  tags: hammerspoon

- name: Deploy Hammerspoon init.lua configuration
  copy:
    src: init.lua
    dest: "{{ ansible_facts['env']['HOME'] }}/.hammerspoon/init.lua"
    mode: '0644'
  register: hammerspoon_config
  tags: hammerspoon

- name: Check if Hammerspoon is running
  shell: pgrep -x Hammerspoon || true
  register: hammerspoon_status
  changed_when: false
  tags: hammerspoon

- name: Start Hammerspoon if not running
  shell: open -a Hammerspoon
  when: hammerspoon_status.stdout == ""
  tags: hammerspoon

# Always reload after starting or if config changed
- name: Reload Hammerspoon configuration
  shell: |
    # Give Hammerspoon time to start if it was just launched
    sleep 1
    # Use hs CLI if available, fall back to osascript
    if command -v hs &> /dev/null; then
      hs -c "hs.reload()"
    else
      osascript -e 'tell application "Hammerspoon" to execute lua code "hs.reload()"'
    fi
  when: hammerspoon_config.changed or hammerspoon_status.stdout == ""
  changed_when: false
  failed_when: false
  tags: hammerspoon
